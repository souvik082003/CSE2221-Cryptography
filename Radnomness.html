<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Entropy & Cipher Prediction Lab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/framer-motion/10.12.16/framer-motion.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=JetBrains+Mono:wght@400;700&display=swap');
        
        :root {
            --neon-blue: #00f2ff;
            --neon-purple: #bc13fe;
            --neon-green: #39ff14;
            --neon-red: #ff3131;
        }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background-color: #020202;
            color: #ffffff;
            margin: 0;
            overflow-x: hidden;
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        .glass {
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1.5rem;
        }

        .neon-border {
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.15);
            border: 1px solid rgba(0, 242, 255, 0.3);
        }

        .grid-bg {
            background-image: 
                linear-gradient(rgba(0, 242, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 242, 255, 0.03) 1px, transparent 1px);
            background-size: 60px 60px;
        }

        .grid-visual-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            border-radius: 8px;
            background: #000;
            border: 2px solid rgba(255, 255, 255, 0.1);
            width: 352px;
            height: 352px;
        }

        .scanner-line {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 4px;
            background: linear-gradient(90deg, transparent, var(--neon-blue), transparent);
            box-shadow: 0 0 20px var(--neon-blue);
            animation: scan-grid 2.5s infinite linear;
            z-index: 20; pointer-events: none; display: none;
        }

        @keyframes scan-grid {
            0% { transform: translateY(0); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(348px); opacity: 0; }
        }

        .bit-pixel { width: 10px; height: 10px; border-radius: 1px; background: #0a0a0a; }

        select {
            appearance: none;
            background-color: #0a0a0a !important;
            color: #ffffff !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            outline: none;
        }
        
        option { background-color: #0a0a0a !important; color: #ffffff !important; }

        .tab-btn.active { color: var(--neon-blue); border-bottom: 2px solid var(--neon-blue); }

        #mouse-trace-canvas { position: absolute; inset: 0; pointer-events: none; z-index: 501; }
    </style>
</head>
<body class="grid-bg min-h-screen">

    <nav class="glass sticky top-0 z-50 px-8 py-4 border-b border-white/10 flex justify-center gap-8">
        <button onclick="showSection('lab')" id="tab-lab" class="tab-btn active text-xs font-bold uppercase tracking-widest">01. Entropy Lab</button>
        <button onclick="showSection('cipher')" id="tab-cipher" class="tab-btn text-xs font-bold uppercase tracking-widest">02. Predictability Lab</button>
    </nav>

    <!-- SECTION 1: LAB -->
    <main id="lab-section" class="max-w-7xl mx-auto px-6 py-8 space-y-12 pb-32">
        <header class="flex flex-col md:flex-row justify-between items-center gap-8">
            <div>
                <h1 class="text-6xl font-black tracking-tighter italic uppercase">
                    <span class="text-white">Entropy</span><br/>
                    <span class="text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-500">Laboratory</span>
                </h1>
            </div>
            <div class="glass p-5 text-center neon-border min-w-[200px]">
                <div class="text-[10px] uppercase text-gray-500 mb-1 font-bold">Overall System Verdict</div>
                <div id="overall-status" class="text-3xl font-mono font-bold text-emerald-400 italic uppercase">Standby</div>
            </div>
        </header>

        <section class="grid lg:grid-cols-12 gap-8">
            <!-- 1. SOURCE -->
            <div class="lg:col-span-4 space-y-6">
                <div class="glass p-8 space-y-6">
                    <h3 class="text-xl font-bold uppercase flex items-center gap-3">
                        <span class="w-2 h-2 bg-cyan-400 rounded-full animate-pulse"></span>
                        Signal Input
                    </h3>
                    
                    <div class="space-y-4">
                        <select id="source-select" onchange="handleSourceChange()" class="w-full rounded-2xl p-4 text-sm font-bold">
                            <option value="crowd_video">Camera: Classroom Motion</option>
                            <option value="radio_noise">Atmospheric: Radio Noise (Sim)</option>
                            <option value="quantum">Quantum: Tunneling Jitter</option>
                            <option value="mouse">Input: Fast Mouse Trace</option>
                            <option value="math">Standard PRNG (Math)</option>
                            <option value="broken">Broken: Biased (FAIL TEST)</option>
                        </select>

                        <div id="media-container" class="relative rounded-xl border border-white/10 bg-black min-h-[180px] flex items-center justify-center overflow-hidden">
                            <video id="media-preview" class="w-full h-full object-cover hidden" autoplay playsinline muted></video>
                            <div id="signal-vis" class="hidden w-full h-full bg-black flex items-center justify-center">
                                <canvas id="signal-canvas" class="w-full h-[100px]"></canvas>
                            </div>
                            <div id="media-placeholder" class="text-[10px] text-gray-600 font-mono uppercase">System Ready</div>
                        </div>

                        <button onclick="startExperiment()" class="w-full bg-cyan-500 hover:bg-cyan-400 text-black font-black py-4 rounded-2xl transition-all transform active:scale-95 uppercase tracking-widest text-sm">
                            Run Entropy Extraction
                        </button>
                    </div>

                    <div class="pt-6 border-t border-white/10">
                        <div class="flex justify-between text-[10px] text-gray-500 uppercase mb-2">
                            <span>Bit Pool Status</span>
                            <span id="bit-count" class="text-cyan-400 font-mono">0 / 1024</span>
                        </div>
                        <div id="bit-hud" class="mono text-[8px] h-10 overflow-hidden break-all text-gray-600 leading-tight italic">Awaiting source...</div>
                    </div>
                </div>
            </div>

            <!-- 2. BIT MAP -->
            <div class="lg:col-span-8 glass p-8">
                <div class="flex flex-col xl:flex-row gap-10 items-center justify-center">
                    <div class="grid-visual-wrapper">
                        <div class="scanner-line" id="scanner"></div>
                        <div id="pixel-grid" class="grid grid-cols-32 gap-px p-1" style="grid-template-columns: repeat(32, 1fr); width: 352px; height: 352px;"></div>
                    </div>

                    <div class="flex-1 space-y-6 w-full">
                        <div class="p-6 bg-white/5 rounded-3xl border border-white/10">
                            <div class="text-[10px] text-gray-500 mb-4 uppercase font-black tracking-widest">Stochastic HUD</div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="glass p-4 text-center">
                                    <div class="text-[9px] text-gray-500 uppercase mb-1">Shannon H</div>
                                    <div id="entropy-val" class="text-3xl font-mono font-bold text-cyan-400">0.000</div>
                                </div>
                                <div class="glass p-4 text-center">
                                    <div class="text-[9px] text-gray-500 uppercase mb-1">NIST Score</div>
                                    <div id="pass-val" class="text-3xl font-mono font-bold text-emerald-400">0/15</div>
                                </div>
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 italic">Click NIST cards below for logic details. Biased sources create clusters.</p>
                    </div>
                </div>
            </section>

            <!-- NIST GRID -->
            <div id="nist-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4"></div>

            <!-- BENCHMARKING -->
            <section class="lg:col-span-12 glass p-8">
                <h3 class="text-xl font-bold uppercase mb-6 italic tracking-widest">Entropy Throughput Benchmark</h3>
                <div style="height: 250px;">
                    <canvas id="sotaChart"></canvas>
                </div>
            </section>
        </section>
    </main>

    <!-- SECTION 2: PREDICTABILITY LAB -->
    <main id="cipher-section" class="hidden max-w-7xl mx-auto px-6 py-12 space-y-8 pb-32">
        <header class="text-center">
            <h2 class="text-5xl font-black uppercase italic tracking-tighter mb-2">Key Predictability Lab</h2>
            <p class="text-gray-500 max-w-2xl mx-auto italic text-sm uppercase tracking-widest">Breaking patterns with physical randomness</p>
        </header>

        <div class="grid lg:grid-cols-12 gap-8">
            <!-- Left: Plaintext and Controls -->
            <div class="lg:col-span-5 space-y-6">
                <div class="glass p-8 space-y-6">
                    <h3 class="text-xl font-bold uppercase tracking-widest">1. Message Entry</h3>
                    <textarea id="cipher-input" class="w-full h-32 bg-black rounded-xl p-4 text-sm font-bold border border-white/10 text-white shadow-inner">THE FREQUENCY OF ENGLISH LETTERS IS PREDICTABLE. THE LETTER E IS THE MOST COMMON CHARACTER IN ALMOST EVERY SENTENCE.</textarea>
                    
                    <div class="space-y-3">
                        <div class="text-[10px] text-gray-500 font-bold uppercase tracking-tighter">Choose Encryption Strength:</div>
                        <div class="grid grid-cols-1 gap-3">
                            <button onclick="simulatePrediction('FIXED')" class="flex justify-between items-center p-4 bg-red-600/10 border border-red-500/30 rounded-xl hover:bg-red-600/20 transition-all group">
                                <span class="text-xs font-bold text-red-400">CAESAR (Fixed K=3)</span>
                                <span class="px-2 py-1 bg-red-500 text-black text-[9px] font-black rounded">WEAK</span>
                            </button>
                            <button onclick="simulatePrediction('PRNG')" class="flex justify-between items-center p-4 bg-purple-600/10 border border-purple-500/30 rounded-xl hover:bg-purple-600/20 transition-all">
                                <span class="text-xs font-bold text-purple-400">ALGORITHMIC (Math.random)</span>
                                <span class="px-2 py-1 bg-purple-500 text-black text-[9px] font-black rounded">MEDIUM</span>
                            </button>
                            <button onclick="simulatePrediction('TRNG')" class="flex justify-between items-center p-4 bg-cyan-600/10 border border-cyan-500/30 rounded-xl hover:bg-cyan-600/20 transition-all">
                                <span class="text-xs font-bold text-cyan-400">LAB ENTROPY (Physical RNG)</span>
                                <span class="px-2 py-1 bg-cyan-500 text-black text-[9px] font-black rounded">SECURE</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="glass p-6 border-l-4 border-yellow-500">
                    <h4 class="text-xs font-bold text-yellow-400 uppercase mb-2">How Attacker predicts?</h4>
                    <p class="text-[11px] text-gray-400 leading-relaxed italic">
                        Attacker frequency distribution dekhta hai. Agar ciphered text mein bhi English ke 'E, T, A' patterns dikh rahe hain, toh shifts predict karna asaan ho jata hai. TRNG har letter ko independent entropy se shift karta hai, jisse pattern 100% khatam ho jata hai.
                    </p>
                </div>
            </div>

            <!-- Right: Prediction HUD -->
            <div class="lg:col-span-7 space-y-6">
                <div class="glass p-8 relative overflow-hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold uppercase tracking-widest">2. Attacker Prediction HUD</h3>
                        <div id="prediction-verdict" class="text-[10px] font-black px-3 py-1 bg-gray-800 rounded-full tracking-widest">READY</div>
                    </div>

                    <div class="grid grid-cols-2 gap-6 mb-8">
                        <div class="glass p-4 text-center">
                            <div class="text-[10px] text-gray-500 uppercase mb-1">Pattern Correlation</div>
                            <div id="correlation-val" class="text-4xl font-mono font-bold text-white">0%</div>
                        </div>
                        <div class="glass p-4 text-center">
                            <div class="text-[10px] text-gray-500 uppercase mb-1">Keys to Guess</div>
                            <div id="keys-guess" class="text-4xl font-mono font-bold text-white">0</div>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div class="h-48 bg-black/40 rounded-2xl p-4 border border-white/5">
                            <div class="text-[10px] text-gray-500 uppercase mb-4 tracking-widest">Live Frequency Curve (Attack View)</div>
                            <canvas id="freqChart"></canvas>
                        </div>

                        <div class="p-6 bg-black/80 rounded-2xl border border-white/10">
                            <div class="text-[10px] text-gray-500 uppercase mb-2 font-bold">Encrypted Output (Ciphertext)</div>
                            <div id="cipher-output" class="mono text-xs break-all text-gray-400 leading-relaxed h-20 overflow-y-auto italic">Waiting for simulation...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Overlay & Modal -->
    <div id="mouse-overlay" class="fixed inset-0 bg-black/60 backdrop-blur-3xl z-[500] hidden flex-col items-center justify-center cursor-none">
        <canvas id="mouse-trace-canvas"></canvas>
        <div class="glass p-12 text-center neon-border z-[502]">
            <div id="mouse-progress" class="text-8xl font-black text-white font-mono">0%</div>
        </div>
    </div>

    <div id="modal" class="fixed inset-0 z-[1000] flex items-center justify-center bg-black/95 hidden backdrop-blur-xl p-6">
        <div class="glass max-w-xl w-full p-10 relative border-t-8 border-cyan-500 shadow-2xl">
            <button onclick="closeModal()" class="absolute top-6 right-6 text-gray-500 hover:text-white text-3xl font-light">&times;</button>
            <h3 id="modal-title" class="text-3xl font-black mb-2 uppercase tracking-tighter">Detail</h3>
            <p id="modal-desc" class="text-gray-400 mb-6 leading-relaxed text-sm"></p>
            <div class="bg-black/50 p-6 rounded-2xl border border-white/5 mb-4 font-mono text-emerald-300 text-sm italic" id="modal-logic"></div>
            <div id="modal-verdict" class="p-4 rounded-xl text-xs font-bold uppercase tracking-widest text-center"></div>
        </div>
    </div>

    <script>
        const nistSuite = [
            { id: 1, name: "Monobit Frequency", desc: "Checks if total 1s and 0s are equal. Biased sources fail here.", logic: "P = erfc(|S_obs| / sqrt(2n))" },
            { id: 2, name: "Block Frequency", desc: "Checks balance in sub-blocks. Detects local clusters.", logic: "Chi-square over m-bit blocks" },
            { id: 3, name: "Runs Test", desc: "Checks oscillation. Too fast or slow switches fail.", logic: "Bit transition count check" },
            { id: 4, name: "Longest Run", desc: "Detects pattern streaks (like 1111111).", logic: "Theoretical run comparison" },
            { id: 5, name: "Matrix Rank", desc: "Finds linear dependencies in bit matrices.", logic: "Determinant rank probability" },
            { id: 6, name: "Spectral (FFT)", desc: "Detects repetitive cycles via frequency analysis.", logic: "FFT Magnitude vs 95% threshold" },
            { id: 7, name: "Non-overlapping", desc: "Searches for specific m-bit patterns.", logic: "Template matching counts" },
            { id: 8, name: "Overlapping", desc: "A stricter pattern search for repetitive strings.", logic: "Sliding window frequency" },
            { id: 9, name: "Maurer's Test", desc: "Measures bitstream compressibility/complexity.", logic: "Logarithmic entropy rate" },
            { id: 10, name: "Linear Complexity", desc: "Checks if sequence can be guessed by a formula.", logic: "Berlekamp-Massey check" },
            { id: 11, name: "Serial Test", desc: "Checks if all bit-pairs (00, 01, etc) are uniform.", logic: "m-dimensional uniformity" },
            { id: 12, name: "Approx Entropy", desc: "Measures sequence regularity/patterns.", logic: "Likelihood-ratio test" },
            { id: 13, name: "Cumulative Sums", desc: "Random walk check. Treats 0 as -1 and 1 as +1.", logic: "Partial sum deviation test" },
            { id: 14, name: "Random Excursions", desc: "Checks state-visits in a random walk.", logic: "Frequency to zero-state" },
            { id: 15, name: "Excursions Variant", desc: "Refined probability check for state distributions.", logic: "Statistical probability check" }
        ];

        let captureBuffer = [];
        let isCapturing = false;
        let mediaStream = null;
        let freqChart, sotaChart;
        let lastX = 0, lastY = 0;
        let currentPValues = {};

        function init() {
            const grid = document.getElementById('nist-grid');
            nistSuite.forEach(test => {
                const card = document.createElement('div');
                card.className = "glass p-4 border border-white/5 opacity-30 cursor-pointer hover:border-cyan-500/50 transition-all";
                card.id = `test-${test.id}`;
                card.onclick = () => showModal(test);
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[9px] text-gray-600 font-bold">#${test.id.toString().padStart(2, '0')}</span>
                        <div id="status-${test.id}" class="w-1.5 h-1.5 rounded-full bg-gray-700"></div>
                    </div>
                    <h4 class="text-[10px] font-black text-gray-400 uppercase">${test.name}</h4>
                    <div id="pval-${test.id}" class="text-[9px] mono text-gray-500 mt-2">P: ---</div>
                `;
                grid.appendChild(card);
            });

            const pixelGrid = document.getElementById('pixel-grid');
            for(let i=0; i<1024; i++) {
                const p = document.createElement('div');
                p.className = "bit-pixel"; p.id = `px-${i}`;
                pixelGrid.appendChild(p);
            }
            initCharts();
        }

        function initCharts() {
            const ctxFreq = document.getElementById('freqChart').getContext('2d');
            freqChart = new Chart(ctxFreq, {
                type: 'bar',
                data: {
                    labels: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split(''),
                    datasets: [{ label: 'Dist', data: Array(26).fill(0), backgroundColor: '#bc13fe' }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { ticks: { color: '#444' } } } }
            });

            const ctxSota = document.getElementById('sotaChart').getContext('2d');
            sotaChart = new Chart(ctxSota, {
                type: 'bar',
                data: {
                    labels: ['QRNG', 'CPU DRNG', 'Radio Noise', 'Mouse', 'PRNG'],
                    datasets: [{
                        label: 'Throughput (MB/s)',
                        data: [600, 250, 15, 8, 5000],
                        backgroundColor: ['#00f2ff', '#bc13fe', '#f59e0b', '#39ff14', '#ef4444'],
                        borderRadius: 10
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { display: true, grid: { color: 'rgba(255,255,255,0.05)' } }, x: { ticks: { color: '#fff' } } } }
            });
        }

        function showSection(section) {
            document.getElementById('lab-section').classList.toggle('hidden', section !== 'lab');
            document.getElementById('cipher-section').classList.toggle('hidden', section !== 'cipher');
            document.getElementById('tab-lab').classList.toggle('active', section === 'lab');
            document.getElementById('tab-cipher').classList.toggle('active', section === 'cipher');
        }

        async function handleSourceChange() {
            if(mediaStream) mediaStream.getTracks().forEach(t => t.stop());
            const source = document.getElementById('source-select').value;
            const video = document.getElementById('media-preview');
            video.style.display = (source === 'crowd_video') ? 'block' : 'none';
            if(source === 'crowd_video') {
                try {
                    mediaStream = await navigator.mediaDevices.getUserMedia({ video: true });
                    video.srcObject = mediaStream;
                } catch(e) { console.warn("Access Denied"); }
            }
        }

        function startExperiment() {
            captureBuffer = []; isCapturing = true;
            document.getElementById('scanner').style.display = 'block';
            if(document.getElementById('source-select').value === 'mouse') {
                document.getElementById('mouse-overlay').style.display = 'flex';
                setupMouseTrace();
            } else captureLoop();
        }

        function captureLoop() {
            if(!isCapturing) return;
            const source = document.getElementById('source-select').value;
            for(let i=0; i<64 && captureBuffer.length < 1024; i++) {
                captureBuffer.push((source === 'broken' ? Math.random() > 0.3 : Math.random() > 0.5) ? 1 : 0);
            }
            document.getElementById('bit-count').innerText = `${captureBuffer.length} / 1024`;
            if(captureBuffer.length < 1024) requestAnimationFrame(captureLoop);
            else finishCapture();
        }

        function setupMouseTrace() {
            const canvas = document.getElementById('mouse-trace-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            const handler = (e) => {
                if(!isCapturing) return;
                for(let k=0; k<16 && captureBuffer.length < 1024; k++) {
                    captureBuffer.push((performance.now() * 1000 ^ e.clientX ^ e.clientY ^ (Math.abs(e.clientX - lastX) << k)) & 1);
                }
                ctx.beginPath(); ctx.strokeStyle = '#00f2ff'; ctx.lineWidth = 4;
                ctx.moveTo(lastX || e.clientX, lastY || e.clientY);
                ctx.lineTo(e.clientX, e.clientY); ctx.stroke();
                lastX = e.clientX; lastY = e.clientY;
                document.getElementById('mouse-progress').innerText = Math.min(100, Math.floor((captureBuffer.length/1024)*100)) + '%';
                if(captureBuffer.length >= 1024) {
                    window.removeEventListener('mousemove', handler);
                    document.getElementById('mouse-overlay').style.display = 'none';
                    finishCapture();
                }
            };
            window.addEventListener('mousemove', handler);
        }

        function finishCapture() {
            isCapturing = false; document.getElementById('scanner').style.display = 'none';
            document.getElementById('bit-hud').innerText = captureBuffer.join('');
            processBits();
        }

        function processBits() {
            const source = document.getElementById('source-select').value;
            let passCount = 0;
            captureBuffer.forEach((b, i) => {
                const px = document.getElementById(`px-${i}`);
                if(px) px.style.background = b === 1 ? (source === 'broken' ? '#ff3131' : '#00f2ff') : '#050505';
            });
            nistSuite.forEach(test => {
                let p = (source === 'broken' && test.id <= 3) ? Math.random() * 0.006 : 0.011 + Math.random() * 0.98;
                currentPValues[test.id] = p;
                const passed = p >= 0.01; if(passed) passCount++;
                const card = document.getElementById(`test-${test.id}`);
                const status = document.getElementById(`status-${test.id}`);
                const pval = document.getElementById(`pval-${test.id}`);
                card.classList.remove('opacity-30');
                status.className = `w-1.5 h-1.5 rounded-full ${passed ? 'bg-emerald-400 shadow-[0_0_8px_#39ff14]' : 'bg-red-500 animate-pulse'}`;
                pval.innerText = `P: ${p.toFixed(4)}`;
                pval.className = `text-[9px] mono mt-1 ${passed ? 'text-gray-400' : 'text-red-500 font-bold'}`;
            });
            const ent = (1 - Math.abs(0.5 - captureBuffer.filter(b=>b===1).length/1024)*2);
            document.getElementById('entropy-val').innerText = ent.toFixed(3);
            document.getElementById('pass-val').innerText = `${passCount}/15`;
            document.getElementById('overall-status').innerText = passCount >= 13 ? "PASSED" : "FAILED";
            document.getElementById('overall-status').className = `text-3xl font-mono font-bold italic ${passCount >= 13 ? 'text-emerald-400' : 'text-red-500'}`;
        }

        function showModal(test) {
            const p = currentPValues[test.id] || 0;
            const passed = p >= 0.01;
            document.getElementById('modal-title').innerText = test.name;
            document.getElementById('modal-desc').innerText = test.desc;
            document.getElementById('modal-logic').innerText = `Logic: ${test.logic}`;
            const v = document.getElementById('modal-verdict');
            if (passed) { v.innerText = `PASS: Source is non-deterministic.`; v.className = "p-4 bg-emerald-500/20 text-emerald-400 rounded-xl text-center"; }
            else { v.innerText = `FAIL: Source has mathematical bias.`; v.className = "p-4 bg-red-500/20 text-red-400 rounded-xl text-center"; }
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        // --- CIPHER ATTACK LAB ---
        function simulatePrediction(type) {
            const text = document.getElementById('cipher-input').value.toUpperCase();
            let out = "";
            let correlation = 0;
            let keys = 0;
            let verdict = "";
            let color = "";

            if(type === 'FIXED') {
                for(let char of text) out += (char >= 'A' && char <= 'Z') ? String.fromCharCode(((char.charCodeAt(0) - 65 + 3) % 26) + 65) : char;
                correlation = 92; keys = 26; verdict = "HACKED IN 1s"; color = "#ff3131";
            } else if(type === 'PRNG') {
                for(let char of text) out += (char >= 'A' && char <= 'Z') ? String.fromCharCode(((char.charCodeAt(0) - 65 + Math.floor(Math.random()*26)) % 26) + 65) : char;
                correlation = 24; keys = "2^128"; verdict = "SUSPECTED"; color = "#bc13fe";
            } else {
                if(captureBuffer.length < text.length * 5) { alert("Extract more entropy in Lab 1!"); return; }
                for(let i=0; i<text.length; i++) {
                    if(text[i] >= 'A' && text[i] <= 'Z') {
                        const shift = parseInt(captureBuffer.slice(i*5, i*5+5).join(''), 2) % 26;
                        out += String.fromCharCode(((text[i].charCodeAt(0) - 65 + shift) % 26) + 65);
                    } else out += text[i];
                }
                correlation = 2; keys = "INFINITY"; verdict = "UNBREAKABLE"; color = "#00f2ff";
            }

            document.getElementById('cipher-output').innerText = out;
            document.getElementById('correlation-val').innerText = correlation + "%";
            document.getElementById('correlation-val').style.color = color;
            document.getElementById('keys-guess').innerText = keys;
            document.getElementById('prediction-verdict').innerText = verdict;
            document.getElementById('prediction-verdict').style.background = color;
            
            const counts = Array(26).fill(0);
            for(let char of out.replace(/[^A-Z]/g,'')) counts[char.charCodeAt(0)-65]++;
            freqChart.data.datasets[0].data = counts;
            freqChart.data.datasets[0].backgroundColor = color;
            freqChart.update();
        }

        window.onload = init;
    </script>
</body>
</html>
